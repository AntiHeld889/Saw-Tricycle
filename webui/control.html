<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Saw Tricycle Websteuerung</title>
  <style>
    :root {
      color-scheme: dark;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0d0d0d;
      color: #f2f2f2;
      margin: 0;
      min-height: 100vh;
      min-height: 100dvh;
      padding: calc(1.4rem + var(--safe-top)) calc(1.4rem + var(--safe-right)) calc(1.4rem + var(--safe-bottom)) calc(1.4rem + var(--safe-left));
      display: flex;
      justify-content: center;
      align-items: center;
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
      gap: 1.2rem;
    }
    .card {
      width: 100%;
      max-width: 860px;
      background: #151515;
      border-radius: 16px;
      padding: clamp(1.2rem, 3vw + 0.4rem, 1.8rem);
      box-shadow: 0 0 40px rgba(0,0,0,0.45);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    .card-header h1 {
      margin: 0;
      font-size: clamp(1.25rem, 2.8vw, 1.6rem);
      font-weight: 600;
    }
    .system-card {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }
    .head-card {
      gap: 0.8rem;
    }
    .system-overview {
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }
    .system-status {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 0.8rem;
      flex-wrap: wrap;
    }
    .system-overview > .battery-indicator {
      align-self: flex-start;
    }
    .system-status .settings-button {
      flex: 0 0 auto;
    }
    .settings-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(229,9,20,0.16);
      border: 1px solid rgba(229,9,20,0.3);
      color: #fff;
      text-decoration: none;
      transition: background 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
    }
    .settings-button:hover {
      background: rgba(229,9,20,0.28);
      border-color: rgba(229,9,20,0.55);
    }
    .settings-button:active {
      transform: scale(0.96);
    }
    .settings-button svg {
      width: 22px;
      height: 22px;
      fill: currentColor;
    }
    .battery-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.6rem 0.25rem 0.4rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 0.82rem;
      line-height: 1;
      color: #f2f2f2;
      transition: background 0.2s ease, border-color 0.2s ease;
      text-decoration: none;
      cursor: pointer;
    }
    .battery-indicator svg {
      width: 34px;
      height: 16px;
    }
    .battery-body {
      fill: none;
      stroke: rgba(255,255,255,0.75);
      stroke-width: 2;
      stroke-linejoin: round;
    }
    .battery-cap {
      fill: rgba(255,255,255,0.75);
    }
    .battery-fill {
      fill: #36d46a;
      transition: fill 0.2s ease, width 0.2s ease;
    }
    .battery-indicator.low .battery-fill {
      fill: #ff3b30;
    }
    .battery-indicator.medium .battery-fill {
      fill: #ffcc00;
    }
    .battery-indicator.charging .battery-fill {
      fill: #33a6ff;
    }
    .battery-indicator.error .battery-fill,
    .battery-indicator.unavailable .battery-fill {
      fill: rgba(242,242,242,0.35);
    }
    .battery-indicator.unavailable {
      opacity: 0.7;
    }
    .battery-indicator span {
      min-width: 2.4rem;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .joystick-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
      align-items: start;
    }
    .joystick-card {
      background: rgba(255,255,255,0.04);
      border-radius: 14px;
      padding: 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .joystick-card h2 { margin: 0; font-size: 1.1rem; font-weight: 600; }
    .joystick {
      position: relative;
      border-radius: 18px;
      border: 2px solid rgba(255,255,255,0.08);
      background: radial-gradient(circle at center, rgba(229,9,20,0.28) 0%, rgba(229,9,20,0.08) 60%, rgba(229,9,20,0.0) 100%);
      width: 100%;
      aspect-ratio: 1 / 1;
      min-height: 180px;
      touch-action: none;
      user-select: none;
      transition: border-color 0.2s ease;
    }
    @supports not (aspect-ratio: 1) {
      .joystick { padding-top: 100%; min-height: 0; }
    }
    .joystick::after { content: ""; position: absolute; inset: 16%; border: 1px dashed rgba(255,255,255,0.08); border-radius: 50%; pointer-events: none; }
    .joystick.axis-x::before { content: ""; position: absolute; left: 50%; top: 12%; bottom: 12%; width: 1px; background: rgba(255,255,255,0.12); transform: translateX(-50%); pointer-events: none; }
    .joystick.axis-y::before { content: ""; position: absolute; top: 50%; left: 12%; right: 12%; height: 1px; background: rgba(255,255,255,0.12); transform: translateY(-50%); pointer-events: none; }
    .joystick .knob { position: absolute; top: 50%; left: 50%; width: 38%; height: 38%; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #ff3f4a, #b30009); box-shadow: 0 10px 22px rgba(229,9,20,0.45); transform: translate(-50%, -50%) translate(var(--tx, 0%), var(--ty, 0%)); transition: transform 90ms ease-out; will-change: transform; }
    .joystick.active { border-color: rgba(229,9,20,0.5); }
    .joystick.active .knob { transition: none; }
    .value { font-variant-numeric: tabular-nums; font-size: 0.95rem; color: #bbb; }
    .value strong { color: #fff; }
    label { font-size: 0.95rem; }
    button {
      background: #e50914;
      border: none;
      color: #fff;
      padding: 0.65rem 1.6rem;
      border-radius: 999px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
      touch-action: manipulation;
      min-height: 44px;
      -webkit-tap-highlight-color: transparent;
    }
    button:hover { background: #ff1a25; }
    button:active { transform: translateY(1px); }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    .head-controls { display: flex; gap: 0.5rem; }
    .head-controls button { flex: 1; padding: 0.55rem 0.6rem; font-size: 0.9rem; }
    .override-toggle { display: inline-flex; align-items: center; gap: 0.4rem; }
    button.ghost { background: rgba(229,9,20,0.16); border: 1px solid rgba(229,9,20,0.32); border-radius: 12px; }
    button.ghost:hover { background: rgba(229,9,20,0.28); }
    button.ghost.active { background: #e50914; border-color: #e50914; box-shadow: 0 0 18px rgba(229,9,20,0.35); }
    input[type="checkbox"] { width: 1.2rem; height: 1.2rem; accent-color: #e50914; }
    .audio-output { display: flex; flex-direction: column; gap: 0.4rem; }
    select {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      color: #fff;
      padding: 0.55rem 0.75rem;
      border-radius: 12px;
      font-size: 0.95rem;
      min-height: 44px;
    }
    select:focus {
      outline: none;
      border-color: rgba(229,9,20,0.55);
      box-shadow: 0 0 0 2px rgba(229,9,20,0.2);
    }
    footer { margin-top: 2rem; font-size: 0.8rem; color: #666; text-align: center; }
    @media (max-width: 900px) {
      body {
        padding: calc(1.1rem + var(--safe-top)) calc(1.1rem + var(--safe-right)) calc(1.1rem + var(--safe-bottom)) calc(1.1rem + var(--safe-left));
        align-items: stretch;
      }
      .card {
        margin: 0 auto;
        border-radius: 14px;
      }
    }
    @media (max-width: 720px) {
      body {
        padding: calc(0.9rem + var(--safe-top)) calc(0.9rem + var(--safe-right)) calc(1rem + var(--safe-bottom)) calc(0.9rem + var(--safe-left));
      }
      .card {
        border-radius: 12px;
        padding: clamp(1rem, 5vw + 0.3rem, 1.4rem);
      }
      .joystick-grid {
        grid-template-columns: minmax(0, 1fr);
        gap: 1.2rem;
      }
      .joystick {
        min-height: clamp(200px, 60vw, 280px);
      }
      .head-card {
        padding: clamp(0.85rem, 4vw, 1rem);
        gap: 0.6rem;
      }
      .head-controls button {
        font-size: 0.95rem;
        padding-block: 0.55rem;
        min-height: 44px;
      }
      .system-card {
        padding: clamp(0.85rem, 4vw, 1rem);
        gap: 0.65rem;
      }
      .system-overview {
        gap: 0.65rem;
      }
      .system-status {
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }
      .system-status .battery-indicator {
        flex: 1 1 55%;
        justify-content: center;
      }
      .system-status .settings-button {
        flex: 0 0 auto;
        width: 46px;
        height: 46px;
        border-radius: 12px;
      }
      .override-toggle {
        justify-content: space-between;
        font-size: 0.95rem;
      }
      .audio-output { width: 100%; }
    }
    @media (max-width: 520px) {
      .card {
        padding: clamp(0.85rem, 5vw, 1.1rem);
      }
      .joystick-card {
        padding: clamp(0.75rem, 4vw, 0.95rem);
        gap: 0.75rem;
      }
      .joystick-card h2 {
        font-size: 1rem;
      }
      .head-controls button {
        font-size: 0.92rem;
        padding-block: 0.5rem;
      }
      .system-status {
        gap: 0.45rem;
      }
      .system-status .battery-indicator {
        transform: scale(0.94);
        transform-origin: left center;
      }
      .settings-button {
        width: 42px;
        height: 42px;
      }
      .settings-button svg {
        width: 20px;
        height: 20px;
      }
    }
    @media (orientation: landscape) and (max-height: 520px) {
      body {
        padding: calc(0.65rem + var(--safe-top)) calc(0.7rem + var(--safe-right)) calc(0.65rem + var(--safe-bottom)) calc(0.7rem + var(--safe-left));
        align-items: stretch;
        justify-content: center;
        gap: 0.7rem;
      }
      .card {
        padding: 0.95rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-height: calc(100dvh - var(--safe-top) - var(--safe-bottom) - 1.1rem);
        overflow-y: auto;
        overscroll-behavior: contain;
      }
      .card-header h1 {
        font-size: 1.18rem;
      }
      .joystick-grid {
        margin-top: 0.15rem;
        gap: 0.7rem;
        grid-template-columns: minmax(0, 1.15fr) repeat(2, minmax(0, 0.85fr)) minmax(0, 1.15fr);
        grid-template-areas: "motor head system steering";
        grid-auto-rows: minmax(0, 1fr);
        align-items: stretch;
      }
      .joystick-card {
        padding: 0.75rem;
        gap: 0.55rem;
        min-height: 0;
      }
      .joystick-card:nth-child(1) { grid-area: motor; }
      .joystick-card.head-card { grid-area: head; }
      .joystick-card.system-card { grid-area: system; }
      .joystick-card:last-child { grid-area: steering; }
      .joystick {
        min-height: clamp(110px, calc((100dvh - var(--safe-top) - var(--safe-bottom)) * 0.32), 150px);
      }
      .head-card {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        gap: 0.5rem;
        text-align: center;
      }
      .head-card h2 {
        margin: 0;
        font-size: 0.92rem;
      }
      .head-controls {
        justify-content: center;
        gap: 0.35rem;
      }
      .head-controls button {
        min-height: 40px;
        padding: 0.42rem 0.5rem;
        font-size: 0.88rem;
        flex: 1 1 0;
      }
      .system-card {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        gap: 0.55rem;
        text-align: center;
      }
      .system-card h2 {
        margin: 0;
        font-size: 0.92rem;
      }
      .system-overview {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        gap: 0.5rem;
      }
      .override-toggle {
        font-size: 0.88rem;
        gap: 0.4rem;
        justify-content: center;
      }
      .system-status {
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.4rem;
      }
      .system-status .battery-indicator {
        flex: 0 1 auto;
        transform: scale(0.92);
        transform-origin: center;
      }
      .system-status .settings-button {
        width: 40px;
        height: 40px;
        border-radius: 10px;
      }
      .card footer {
        margin-top: 0.35rem;
        font-size: 0.7rem;
      }
    }
    @media (orientation: landscape) and (max-height: 430px) {
      body {
        padding: calc(0.55rem + var(--safe-top)) calc(0.6rem + var(--safe-right)) calc(0.55rem + var(--safe-bottom)) calc(0.6rem + var(--safe-left));
        gap: 0.6rem;
      }
      .card {
        padding: 0.8rem;
        gap: 0.6rem;
      }
      .joystick-grid {
        gap: 0.55rem;
        grid-template-columns: minmax(0, 1.15fr) repeat(2, minmax(0, 0.85fr)) minmax(0, 1.15fr);
        grid-template-areas: "motor head system steering";
      }
      .joystick {
        min-height: clamp(100px, calc((100dvh - var(--safe-top) - var(--safe-bottom)) * 0.28), 130px);
      }
      .head-controls button {
        min-height: 38px;
        font-size: 0.85rem;
      }
    }
    @media (pointer: coarse) {
      button { font-size: 1.05rem; }
      .head-controls button { font-size: 1.05rem; }
      .value { font-size: 1.05rem; }
      label { font-size: 1.05rem; }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="card-header">
      <h1>Saw Tricycle</h1>
    </div>
    <div class="joystick-grid">
      <div class="joystick-card">
        <h2>Motor</h2>
        <div id="motorStick" class="joystick axis-y"><div class="knob"></div></div>
        <div class="value">Motor: <strong><span id="motorVal">+0.00</span></strong></div>
      </div>
      <div class="joystick-card head-card">
        <h2>Kopf</h2>
        <div class="head-controls">
          <button class="ghost" type="button" data-head-value="-1" title="Kopf nach links" aria-label="Kopf nach links">L</button>
          <button class="ghost" type="button" data-head-value="0" title="Kopf zentrieren" aria-label="Kopf zentrieren">Z</button>
          <button class="ghost" type="button" data-head-value="1" title="Kopf nach rechts" aria-label="Kopf nach rechts">R</button>
        </div>
      </div>
      <div class="joystick-card system-card">
        <h2>System</h2>
        <div class="system-overview">
          <a id="batteryIndicator" class="battery-indicator unavailable" aria-live="polite" title="Akkustand unbekannt" href="/battery">
            <svg viewBox="0 0 46 24" aria-hidden="true" focusable="false">
              <rect class="battery-body" x="1" y="5" width="36" height="14" rx="3" ry="3" />
              <rect class="battery-cap" x="38" y="9" width="6" height="6" rx="1.5" ry="1.5" />
              <rect id="batteryFill" class="battery-fill" x="3" y="7" width="0" height="10" rx="2" ry="2" />
            </svg>
            <span id="batteryLabel">--%</span>
          </a>
          <div class="override-toggle">
            <input id="override" type="checkbox">
            <label for="override">Web-Override aktivieren</label>
          </div>
          <div class="system-status">
            <a id="soundboardButton" class="settings-button soundboard-button" href="#" title="Soundboard öffnen" aria-label="Soundboard öffnen" target="_blank" rel="noopener" hidden>
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M3 9v6h4l5 5V4L7 9H3z"/>
                <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03z"/>
                <path d="M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
              </svg>
            </a>
            <a id="cameraButton" class="settings-button camera-button" href="#" title="Kamera öffnen" aria-label="Kamera öffnen" target="_blank" rel="noopener" hidden>
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M4 6h3.17l1.41-1.41A2 2 0 0 1 9.83 4h4.34a2 2 0 0 1 1.41.59L17 6h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2Zm8 3a5 5 0 1 0 0 10 5 5 0 0 0 0-10Zm0 2a3 3 0 1 1 0 6 3 3 0 0 1 0-6Z"/>
              </svg>
            </a>
            <a class="settings-button" href="/settings" title="Einstellungen" aria-label="Einstellungen öffnen">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.1 7.1 0 0 0-1.62-.94l-.36-2.54A.5.5 0 0 0 14.92 2h-3.84a.5.5 0 0 0-.5.43l-.36 2.54a7.1 7.1 0 0 0-1.62.94l-2.39-.96a.5.5 0 0 0-.6.22L3.69 8.45a.5.5 0 0 0 .12.64l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.5.5 0 0 0-.12.64l1.92 3.32c.14.24.43.33.68.22l2.39-.96c.49.39 1.04.71 1.62.94l.36 2.54c.04.25.25.43.5.43h3.84c.25 0 .46-.18.5-.43l.36-2.54c.58-.23 1.13-.55 1.62-.94l2.39.96c.25.11.54.02.68-.22l1.92-3.32a.5.5 0 0 0-.12-.64zm-7.14 2.56a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7z"/>
              </svg>
            </a>
          </div>
        </div>
      </div>
      <div class="joystick-card">
        <h2>Lenkung</h2>
        <div id="steeringStick" class="joystick axis-x"><div class="knob"></div></div>
        <div class="value">Lenkung: <strong><span id="steeringVal">+0.00</span></strong></div>
      </div>
    </div>
    <footer>Läuft auf Port 8081 · Ziehen/Tippen zum Steuern</footer>
  </div>
  <script>
    const clampValue = (value) => {
      const num = Number.parseFloat(value);
      if (!Number.isFinite(num)) {
        return 0;
      }
      return Math.max(-1, Math.min(1, num));
    };

    const state = { steering: 0, motor: 0, head: 0, override: false, audioDevice: null, audioVolume: null, soundboardPort: null, cameraTarget: null };
    const steeringVal = document.getElementById('steeringVal');
    const motorVal = document.getElementById('motorVal');
    const headButtons = Array.from(document.querySelectorAll('[data-head-value]'));
    const override = document.getElementById('override');
    const audioSelect = document.getElementById('audioDevice');
    const batteryIndicator = document.getElementById('batteryIndicator');
    const batteryFill = document.getElementById('batteryFill');
    const batteryLabel = document.getElementById('batteryLabel');
    const soundboardButton = document.getElementById('soundboardButton');
    const cameraButton = document.getElementById('cameraButton');
    const BATTERY_CLASSES = ['charging', 'low', 'medium', 'error', 'unavailable'];
    const BATTERY_MAX_WIDTH = 32;
    let audioOptionsSignature = '';
    if (audioSelect) {
      audioSelect.disabled = true;
    }

    const formatValue = (value) => {
      const rounded = clampValue(value);
      return `${rounded >= 0 ? '+' : ''}${rounded.toFixed(2)}`;
    };

    const parseSoundboardPort = (value) => {
      if (typeof value === 'number') {
        return Number.isInteger(value) && value >= 1 && value <= 65535 ? value : null;
      }
      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (!trimmed) {
          return null;
        }
        const parsed = Number.parseInt(trimmed, 10);
        if (Number.isInteger(parsed) && parsed >= 1 && parsed <= 65535) {
          return parsed;
        }
      }
      return null;
    };

    const parseCameraTarget = (value) => {
      if (typeof value === 'number') {
        if (Number.isInteger(value) && value >= 1 && value <= 65535) {
          return { port: value, path: '', raw: String(value) };
        }
        return null;
      }
      if (typeof value !== 'string') {
        return null;
      }
      const trimmed = value.trim();
      if (!trimmed) {
        return null;
      }
      const slashIndex = trimmed.indexOf('/');
      const portPart = slashIndex === -1 ? trimmed : trimmed.slice(0, slashIndex);
      const pathPart = slashIndex === -1 ? '' : trimmed.slice(slashIndex + 1);
      const numeric = Number.parseInt(portPart, 10);
      if (!Number.isInteger(numeric) || numeric < 1 || numeric > 65535) {
        return null;
      }
      let normalizedPath = '';
      if (pathPart) {
        const segments = pathPart
          .split('/')
          .map((segment) => segment.trim())
          .filter(Boolean);
        if (segments.length > 0) {
          normalizedPath = `/${segments.join('/')}`;
          if (pathPart.trim().endsWith('/') && !normalizedPath.endsWith('/')) {
            normalizedPath += '/';
          }
        }
      }
      return { port: numeric, path: normalizedPath, raw: `${numeric}${normalizedPath}` };
    };

    const buildServiceUrl = (port) => {
      const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
      const hostname = window.location.hostname || 'localhost';
      let host = hostname;
      if (host.includes(':') && !host.startsWith('[')) {
        host = `[${host}]`;
      }
      return `${protocol}//${host}:${port}/`;
    };

    const buildSoundboardUrl = (port) => buildServiceUrl(port);
    const buildCameraUrl = (target) => {
      if (!target || !target.port) {
        return '#';
      }
      const base = buildServiceUrl(target.port);
      if (!target.path) {
        return base;
      }
      const trimmedBase = base.endsWith('/') ? base.slice(0, -1) : base;
      return `${trimmedBase}${target.path}`;
    };

    const updateSoundboardButton = (port) => {
      if (!soundboardButton) {
        return;
      }
      const numeric = parseSoundboardPort(port);
      if (numeric === null) {
        soundboardButton.hidden = true;
        soundboardButton.dataset.url = '';
        soundboardButton.removeAttribute('data-port');
        soundboardButton.href = '#';
        return;
      }
      const url = buildSoundboardUrl(numeric);
      soundboardButton.hidden = false;
      soundboardButton.dataset.url = url;
      soundboardButton.dataset.port = String(numeric);
      soundboardButton.href = url;
    };

    const updateCameraButton = (target) => {
      if (!cameraButton) {
        return;
      }
      if (!target) {
        cameraButton.hidden = true;
        cameraButton.dataset.url = '';
        cameraButton.removeAttribute('data-port');
        cameraButton.removeAttribute('data-path');
        cameraButton.removeAttribute('data-raw');
        cameraButton.href = '#';
        return;
      }
      const url = buildCameraUrl(target);
      cameraButton.hidden = false;
      cameraButton.dataset.url = url;
      cameraButton.dataset.port = String(target.port);
      if (target.path) {
        cameraButton.dataset.path = target.path;
      } else {
        cameraButton.removeAttribute('data-path');
      }
      cameraButton.dataset.raw = target.raw;
      cameraButton.href = url;
    };

    if (soundboardButton) {
      updateSoundboardButton(null);
      soundboardButton.addEventListener('click', (event) => {
        const url = soundboardButton.dataset.url;
        if (!url) {
          event.preventDefault();
          return;
        }
        event.preventDefault();
        window.open(url, '_blank', 'noopener');
      });
    }

    if (cameraButton) {
      updateCameraButton(null);
      cameraButton.addEventListener('click', (event) => {
        const url = cameraButton.dataset.url;
        if (!url) {
          event.preventDefault();
          return;
        }
        event.preventDefault();
        window.open(url, '_blank', 'noopener');
      });
    }

    const updateBattery = (info) => {
      if (!batteryIndicator || !batteryFill || !batteryLabel) {
        return;
      }
      batteryIndicator.classList.remove(...BATTERY_CLASSES);
      if (!info || typeof info !== 'object') {
        batteryLabel.textContent = '--%';
        batteryFill.setAttribute('width', '0');
        batteryIndicator.classList.add('unavailable');
        batteryIndicator.title = 'Akkustand nicht verfügbar';
        return;
      }
      const percentRaw = Number(info.percent);
      const percent = Number.isFinite(percentRaw) ? Math.max(0, Math.min(100, percentRaw)) : null;
      const voltageRaw = Number(info.voltage);
      const voltage = Number.isFinite(voltageRaw) ? voltageRaw : null;
      const currentRaw = Number(info.current);
      const current = Number.isFinite(currentRaw) ? currentRaw : null;
      const powerRaw = Number(info.power);
      const power = Number.isFinite(powerRaw) ? powerRaw : null;
      const status = typeof info.status === 'string' ? info.status : 'unknown';

      if (percent === null) {
        batteryLabel.textContent = '--%';
        batteryFill.setAttribute('width', '0');
      } else {
        batteryLabel.textContent = `${Math.round(percent)}%`;
        const width = (BATTERY_MAX_WIDTH * percent) / 100;
        batteryFill.setAttribute('width', width > 0 ? width.toFixed(1) : '0');
      }

      let indicatorClass = null;
      if (status === 'error') {
        indicatorClass = 'error';
      } else if (status === 'charging') {
        indicatorClass = 'charging';
      } else if (status === 'initializing') {
        indicatorClass = 'unavailable';
      } else if (percent === null) {
        indicatorClass = 'unavailable';
      } else if (percent <= 20) {
        indicatorClass = 'low';
      } else if (percent <= 50) {
        indicatorClass = 'medium';
      }
      if (indicatorClass) {
        batteryIndicator.classList.add(indicatorClass);
      }

      const parts = [];
      if (percent === null) {
        parts.push('Akkuladung unbekannt');
      } else {
        parts.push(`Akkuladung ${Math.round(percent)}%`);
      }
      if (voltage !== null) {
        parts.push(`${voltage.toFixed(2)} V`);
      }
      if (current !== null) {
        const sign = current >= 0 ? '+' : '';
        parts.push(`${sign}${current.toFixed(2)} A`);
      }
      if (power !== null) {
        const sign = power >= 0 ? '+' : '';
        parts.push(`${sign}${power.toFixed(2)} W`);
      }
      if (status === 'charging') {
        parts.push('lädt');
      } else if (status === 'discharging') {
        parts.push('entlädt');
      } else if (status === 'idle') {
        parts.push('Ruhezustand');
      } else if (status === 'error') {
        parts.push('Sensorfehler');
      } else if (status === 'initializing') {
        parts.push('Initialisierung läuft');
      } else if (status === 'unknown') {
        parts.push('Status unbekannt');
      }
      batteryIndicator.title = parts.join(' · ');
    };

    const updateLabels = () => {
      steeringVal.textContent = formatValue(state.steering);
      motorVal.textContent = formatValue(state.motor);
    };

    const updateHeadButtons = () => {
      headButtons.forEach((button) => {
        const raw = button.dataset.headValue;
        const value = Number.parseFloat(raw ?? '0');
        if (!Number.isFinite(value)) {
          return;
        }
        button.classList.toggle('active', Math.abs(state.head - value) < 0.01);
      });
    };

    const syncAudioSelection = (options, selectedId) => {
      if (!audioSelect) {
        return;
      }
      const normalized = Array.isArray(options)
        ? options
            .map((opt) => ({ id: opt?.id ?? '', label: opt?.label ?? String(opt?.id ?? '') }))
            .filter((opt) => String(opt.id).length > 0)
        : [];
      const signature = JSON.stringify(normalized);
      if (signature !== audioOptionsSignature) {
        audioOptionsSignature = signature;
        audioSelect.innerHTML = '';
        normalized.forEach((opt) => {
          const option = document.createElement('option');
          option.value = String(opt.id);
          option.textContent = opt.label;
          audioSelect.append(option);
        });
      }
      const desired = String(selectedId ?? '');
      const hasDesired = normalized.some((opt) => String(opt.id) === desired);
      const fallback = normalized.length > 0 ? String(normalized[0].id) : '';
      const targetValue = hasDesired ? desired : fallback;
      if (audioSelect.value !== targetValue) {
        audioSelect.value = targetValue;
      }
      audioSelect.disabled = normalized.length === 0;
      state.audioDevice = targetValue || null;
    };

    const setHead = (value, emit = true) => {
      state.head = clampValue(value);
      updateLabels();
      updateHeadButtons();
      if (emit) {
        sendState();
      }
    };

    function createJoystick(id, axis, onInput) {
      const pad = document.getElementById(id);
      let pointerId = null;
      let active = false;
      let value = 0;
      const travel = 42; // Prozentuale Auslenkung für den Knopf

      const render = () => {
        if (axis === 'x') {
          pad.style.setProperty('--tx', `${value * travel}%`);
          pad.style.setProperty('--ty', '0%');
        } else {
          pad.style.setProperty('--ty', `${value * -travel}%`);
          pad.style.setProperty('--tx', '0%');
        }
      };

      const applyValue = (next, emit) => {
        value = clampValue(next);
        render();
        if (emit && typeof onInput === 'function') {
          onInput(value);
        }
      };

      const updateFromPointer = (event) => {
        const rect = pad.getBoundingClientRect();
        let next = 0;
        if (axis === 'x') {
          const centerX = rect.left + rect.width / 2;
          next = (event.clientX - centerX) / (rect.width / 2);
        } else {
          const centerY = rect.top + rect.height / 2;
          next = (centerY - event.clientY) / (rect.height / 2);
        }
        applyValue(next, true);
      };

      const releasePointer = (event) => {
        if (event.pointerId !== pointerId) {
          return;
        }
        try {
          pad.releasePointerCapture(pointerId);
        } catch (err) {
          /* ignore */
        }
        pointerId = null;
        active = false;
        pad.classList.remove('active');
        applyValue(0, true);
      };

      pad.addEventListener('pointerdown', (event) => {
        event.preventDefault();
        pointerId = event.pointerId;
        active = true;
        pad.classList.add('active');
        try {
          pad.setPointerCapture(pointerId);
        } catch (err) {
          /* ignore */
        }
        updateFromPointer(event);
      });

      pad.addEventListener('pointermove', (event) => {
        if (!active || event.pointerId !== pointerId) {
          return;
        }
        updateFromPointer(event);
      });

      pad.addEventListener('pointerup', releasePointer);
      pad.addEventListener('pointercancel', releasePointer);
      pad.addEventListener('contextmenu', (event) => {
        event.preventDefault();
      });

      return {
        setValue(next) {
          applyValue(next, false);
        },
        reset() {
          applyValue(0, false);
        },
        get value() {
          return value;
        },
        get active() {
          return active;
        }
      };
    }

    async function sendState(overrides = {}) {
      const payload = {
        steering: clampValue(overrides.steering ?? state.steering),
        motor: clampValue(overrides.motor ?? state.motor),
        head: clampValue(overrides.head ?? state.head),
        override: overrides.override ?? state.override
      };
      state.steering = payload.steering;
      state.motor = payload.motor;
      state.head = payload.head;
      state.override = payload.override;
      const audioDevice = overrides.audioDevice ?? state.audioDevice;
      if (typeof audioDevice === 'string' && audioDevice.length > 0) {
        payload.audio_device = audioDevice;
        state.audioDevice = audioDevice;
      }
      const audioVolume = overrides.audioVolume ?? state.audioVolume;
      if (Number.isFinite(audioVolume)) {
        const normalized = Math.max(0, Math.min(100, audioVolume));
        payload.audio_volume = Math.round(normalized);
        state.audioVolume = normalized;
      }
      try {
        await fetch('/api/control', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.error('Senden fehlgeschlagen', err);
      }
    }

    const steeringStick = createJoystick('steeringStick', 'x', (value) => {
      state.steering = value;
      updateLabels();
      sendState();
    });

    const motorStick = createJoystick('motorStick', 'y', (value) => {
      state.motor = value;
      updateLabels();
      sendState();
    });

    headButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const raw = button.dataset.headValue;
        const value = Number.parseFloat(raw ?? '0');
        if (!Number.isFinite(value)) {
          return;
        }
        setHead(value);
      });
    });

    override.addEventListener('change', () => {
      state.override = override.checked;
      sendState();
    });

    if (audioSelect) {
      audioSelect.addEventListener('change', () => {
        const value = audioSelect.value;
        state.audioDevice = value || null;
        if (state.audioDevice) {
          sendState({ audioDevice: state.audioDevice });
        }
      });
    }

    async function pollState() {
      try {
        const resp = await fetch('/api/state');
        if (!resp.ok) {
          return;
        }
        const data = await resp.json();
        const remoteSteering = clampValue(data.steering ?? 0);
        const remoteMotor = clampValue(data.motor ?? 0);
        const remoteHead = clampValue(data.head ?? 0);
        const remoteOverride = Boolean(data.override);
        const remoteAudioDevice = typeof data.audio_device === 'string' ? data.audio_device : null;
        const remoteAudioOutputs = Array.isArray(data.audio_outputs) ? data.audio_outputs : [];

        if (!steeringStick.active) {
          state.steering = remoteSteering;
          steeringStick.setValue(remoteSteering);
        }
        if (!motorStick.active) {
          state.motor = remoteMotor;
          motorStick.setValue(remoteMotor);
        }
        state.head = remoteHead;
        state.override = remoteOverride;
        override.checked = remoteOverride;
        updateHeadButtons();
        updateLabels();
        syncAudioSelection(remoteAudioOutputs, remoteAudioDevice);
        if (data.audio_volume && Number.isFinite(data.audio_volume.value)) {
          state.audioVolume = data.audio_volume.value;
        } else {
          state.audioVolume = null;
        }
        updateBattery(data.battery ?? null);
        const soundInfo = data.sound && typeof data.sound === 'object' ? data.sound : null;
        const portValue = soundInfo ? parseSoundboardPort(soundInfo.soundboard_port) : null;
        const cameraValue = soundInfo ? parseCameraTarget(soundInfo.camera_port) : null;
        state.soundboardPort = portValue;
        state.cameraTarget = cameraValue;
        updateSoundboardButton(portValue);
        updateCameraButton(cameraValue);
      } catch (err) {
        console.error('Poll fehlgeschlagen', err);
      }
    }

    updateLabels();
    updateHeadButtons();
    updateBattery(null);
    updateSoundboardButton(null);
    updateCameraButton(null);
    pollState();
    setInterval(pollState, 1500);
  </script>
</body>
</html>
