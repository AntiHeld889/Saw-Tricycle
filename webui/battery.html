<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Akku-Details · Saw Tricycle</title>
  <style>
    :root {
      color-scheme: dark;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0d0d0d;
      color: #f2f2f2;
      margin: 0;
      min-height: 100vh;
      min-height: 100dvh;
      padding: calc(1.4rem + var(--safe-top)) calc(1.4rem + var(--safe-right)) calc(1.4rem + var(--safe-bottom)) calc(1.4rem + var(--safe-left));
      display: flex;
      justify-content: center;
      align-items: center;
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }
    .card {
      width: 100%;
      max-width: 520px;
      background: rgba(21, 21, 21, 0.95);
      border-radius: 18px;
      padding: clamp(1.4rem, 4vw + 0.6rem, 2rem);
      box-shadow: 0 0 40px rgba(0,0,0,0.45);
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }
    .card-header {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .back-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.04);
      color: #f2f2f2;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.2s ease, border-color 0.2s ease, transform 0.15s ease;
    }
    .back-button:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.22);
    }
    .back-button:active {
      transform: scale(0.96);
    }
    .back-button svg {
      width: 22px;
      height: 22px;
      fill: currentColor;
    }
    h1 {
      font-size: clamp(1.4rem, 4vw + 0.2rem, 1.85rem);
      margin: 0;
    }
    .status {
      padding: 0.9rem 1rem;
      border-radius: 12px;
      font-size: 0.95rem;
      line-height: 1.4;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .status.status-error {
      background: rgba(255, 59, 48, 0.12);
      border-color: rgba(255, 59, 48, 0.35);
      color: #ff6b60;
    }
    .status.status-success {
      background: rgba(54, 212, 106, 0.12);
      border-color: rgba(54, 212, 106, 0.35);
      color: #73ff9b;
    }
    .status.status-info {
      background: rgba(51, 166, 255, 0.12);
      border-color: rgba(51, 166, 255, 0.35);
      color: #7fc8ff;
    }
    dl {
      margin: 0;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.9rem 1.2rem;
    }
    dt {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(242,242,242,0.7);
      margin: 0;
    }
    dd {
      margin: 0.15rem 0 0;
      font-size: 1.35rem;
      font-variant-numeric: tabular-nums;
    }
    .timestamp {
      margin: 0.4rem 0 0;
      font-size: 0.85rem;
      color: rgba(242,242,242,0.7);
    }
    @media (max-width: 480px) {
      dl {
        grid-template-columns: minmax(0, 1fr);
      }
      dd {
        font-size: 1.2rem;
      }
    }
    @media (orientation: landscape) and (max-height: 520px) {
      body {
        padding: calc(0.7rem + var(--safe-top)) calc(0.75rem + var(--safe-right)) calc(0.7rem + var(--safe-bottom)) calc(0.75rem + var(--safe-left));
        align-items: stretch;
      }
      .card {
        padding: 1rem;
        gap: 1rem;
        max-height: calc(100dvh - var(--safe-top) - var(--safe-bottom) - 1.2rem);
        overflow-y: auto;
        overscroll-behavior: contain;
      }
      dl {
        gap: 0.8rem 1rem;
      }
      dd {
        font-size: 1.2rem;
      }
    }
    @media (orientation: landscape) and (max-height: 430px) {
      body {
        padding: calc(0.6rem + var(--safe-top)) calc(0.65rem + var(--safe-right)) calc(0.6rem + var(--safe-bottom)) calc(0.65rem + var(--safe-left));
      }
      .card {
        padding: 0.85rem;
        gap: 0.85rem;
      }
      dl {
        gap: 0.75rem 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="card-header">
      <a class="back-button" href="/" aria-label="Zurück zur Steuerung">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6z"/></svg>
      </a>
      <h1>Akku-Details</h1>
    </div>
    <div id="status" class="status status-info" role="status">Werte werden geladen …</div>
    <dl>
      <div>
        <dt>Status</dt>
        <dd id="valueStatus">–</dd>
      </div>
      <div>
        <dt>Akkuladung</dt>
        <dd id="valuePercent">-- %</dd>
      </div>
      <div>
        <dt>Spannung</dt>
        <dd id="valueVoltage">-- V</dd>
      </div>
      <div>
        <dt>Strom</dt>
        <dd id="valueCurrent">-- A</dd>
      </div>
      <div>
        <dt>Leistung</dt>
        <dd id="valuePower">-- W</dd>
      </div>
      <div>
        <dt>Ladezustand</dt>
        <dd id="valueCharging">–</dd>
      </div>
    </dl>
    <p class="timestamp">Zuletzt aktualisiert: <span id="valueTimestamp">--</span></p>
  </div>
  <script>
    const statusEl = document.getElementById('status');
    const valueStatus = document.getElementById('valueStatus');
    const valuePercent = document.getElementById('valuePercent');
    const valueVoltage = document.getElementById('valueVoltage');
    const valueCurrent = document.getElementById('valueCurrent');
    const valuePower = document.getElementById('valuePower');
    const valueCharging = document.getElementById('valueCharging');
    const valueTimestamp = document.getElementById('valueTimestamp');

    const STATUS_LABELS = {
      charging: 'Lädt',
      discharging: 'Entlädt',
      idle: 'Ruhezustand',
      error: 'Sensorfehler',
      initializing: 'Initialisierung',
      unavailable: 'Nicht verfügbar',
      unknown: 'Unbekannt'
    };

    function setStatus(message, tone = 'info') {
      statusEl.textContent = message;
      statusEl.classList.remove('status-error', 'status-success', 'status-info');
      statusEl.classList.add(`status-${tone}`);
    }

    function formatNumber(value, unit, digits = 2) {
      if (!Number.isFinite(value)) {
        return `--\u00A0${unit}`;
      }
      return `${value.toFixed(digits)}\u00A0${unit}`;
    }

    function formatPercent(value) {
      if (!Number.isFinite(value)) {
        return '--\u00A0%';
      }
      return `${Math.round(Math.max(0, Math.min(100, value)))}\u00A0%`;
    }

    function describeCharging(flag, status) {
      if (typeof flag !== 'boolean') {
        if (status === 'charging') {
          return 'Ja';
        }
        if (status === 'discharging') {
          return 'Nein';
        }
        return '–';
      }
      return flag ? 'Ja' : 'Nein';
    }

    function formatTimestamp(value) {
      if (!Number.isFinite(value) || value <= 0) {
        return '--';
      }
      try {
        const date = new Date(value * 1000);
        return date.toLocaleString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      } catch (err) {
        return '--';
      }
    }

    function updateView(payload) {
      if (!payload || typeof payload !== 'object') {
        valueStatus.textContent = 'Nicht verfügbar';
        valuePercent.textContent = '--\u00A0%';
        valueVoltage.textContent = '--\u00A0V';
        valueCurrent.textContent = '--\u00A0A';
        valuePower.textContent = '--\u00A0W';
        valueCharging.textContent = '–';
        valueTimestamp.textContent = '--';
        setStatus('Akku-Daten sind nicht verfügbar.', 'error');
        return;
      }

      const percent = Number(payload.percent);
      const voltage = Number(payload.voltage);
      const current = Number(payload.current);
      const power = Number(payload.power);
      const status = typeof payload.status === 'string' ? payload.status : 'unknown';
      const chargingFlag = typeof payload.charging === 'boolean' ? payload.charging : null;
      const timestamp = Number(payload.timestamp);

      valueStatus.textContent = STATUS_LABELS[status] ?? STATUS_LABELS.unknown;
      valuePercent.textContent = formatPercent(percent);
      valueVoltage.textContent = formatNumber(voltage, 'V', 2);
      valueCurrent.textContent = formatNumber(current, 'A', 2);
      valuePower.textContent = formatNumber(power, 'W', 2);
      valueCharging.textContent = describeCharging(chargingFlag, status);
      valueTimestamp.textContent = formatTimestamp(timestamp);

      if (status === 'error') {
        setStatus('Sensorfehler – bitte Verkabelung und Stromversorgung prüfen.', 'error');
      } else if (status === 'initializing') {
        setStatus('Sensor initialisiert … bitte warten.', 'info');
      } else if (status === 'unavailable') {
        setStatus('Akku-Daten stehen nicht zur Verfügung.', 'error');
      } else {
        setStatus('Akku-Daten aktualisiert.', 'success');
      }
    }

    async function pollBattery() {
      try {
        const response = await fetch('/api/battery');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        updateView(data);
      } catch (error) {
        console.error('Abfrage der Akku-Daten fehlgeschlagen', error);
        updateView(null);
      }
    }

    pollBattery();
    setInterval(pollBattery, 2000);
  </script>
</body>
</html>
